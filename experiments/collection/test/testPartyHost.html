<!DOCTYPE HTML>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src='../../../a2a-stub/include/a2a-stub.js'></script>
<!--<script type="text/javascript" charset="utf-8" src='../include/hash.js'></script>!-->
<script type="text/javascript" charset="utf-8" src='../../../apps/common/Collection.js'></script>
<script type="text/javascript" charset="utf-8" src='../../../apps/host/PartyCollection.js'></script>
<script type="text/javascript" charset="utf-8" src='../include/item_interface.js'></script>


<style>
body { font-family: sans-serif; }
#log { clear: both; }
.logline {
    font-family: monospace;
    color: #ddd;
    background: #333;
    clear: both;
}
</style>

<script type=text/javascript>
    var channel = null;
    var coll = null;



    // creates a party with a temporary collection and some users;+connects to sockets
    $(document).ready(function () {
		createParty();
		//init();
		//search();
		//create();
    }
    );

    function log(message)
    {
        var logline = document.createElement('div');
        logline.setAttribute('class', 'logline');
        logline.innerHTML=message;
        var log = document.getElementById('log');
        log.insertBefore(logline, log.firstElementChild);
    }

    // in real life there would be no init(), this is a temporary solution
    function init()
    {
        webinos.app2app.init('ws://localhost:10666/a2a-stub');
        //webinos.app2app.createChannel('urn:partyplayer', null, function(msg) { log(msg); });
    }

    function search()
    {
        webinos.app2app.searchForChannels(
            'urn:webinos.org:*', [],
            function(channel) {
                log('Found channel with namespace ' +  channel.namespace);
            });
    }

    function create()
    {
        channel = webinos.app2app.createChannel(
            'urn:webinos.org:partyplayer', null, alwaysTrue,
            function handleMessage(payload) {
                // payload is an object
                log('Received payload: ' + JSON.stringify(payload));
		//payloadDec = JSON.parse(payload);
		determineAction(payload);
            });
    }

    function send()
    {
        channel.send(document.getElementById('message').value);
    }

    function alwaysTrue()
    {
        return true;
    }

    

    //**start party code

	//stub user collection
	//@todo, replace with user registration code
	var users = {
		"Victor":1, "Daryll":2,"Arno":3,"Fabian":4, 1:"Victor",2:"Daryll",3:"Arno", 4:"Fabian"
	};
	

    /**
     * Control interface for the party player app. 
     * Input: json messages sent via webinos app2app framework.
     * Based on message type, the right functionality of the partyplayer is revoked.
     * The result is transmitted to the sending paryt / all subscribed parties
     **/
    function determineAction(payload)
    {
	//console.log("determine-action, payloadCMD="+payload.cmd);

	var msg = {}; //return message structure
	msg.type="collection";
	msg.cmd="addItem";
	msg.result={};
	var str = ""
		
     	switch (payload.cmd) {
		case 'join':
			msg.cmd=payload.cmd;
			ret = coll.addUser(payload.args);
			msg.result["userID"]=ret;
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;			
		case 'leave':
			msg.cmd=payload.cmd;
			ret = coll.removeUser(payload.args);
			msg.result["result"]=ret;
			str = JSON.stringify(msg);
			channel.send(msg)			 	
			break;
		case "getUsers":
			msg.cmd="getUsers";
			ret = coll.getUsers();
			msg.result["users"]=ret;
			msg.result["collection"]=ret;
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		case 'addItem':
			msg.cmd="addItem";
			console.log("Adding item");
			ret = coll.addItem(payload.args.userID,payload.args.item);
			if (ret != false)
			{
				msg.result["result"]="OK";
				msg.result["itemID"]=ret;
			}
			else{
				msg.result["result"]="NOK";	
			}
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		case 'addItems':
			msg.result["result"]="NOK";
			msg.cmd="addItems";
			msg.result["msg"]="feature not yet supported";
			msg.result["collection"]=ret;
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		case 'getItemCount':
			msg.result["result"]="OK";
			msg.cmd='getItemCount';
			ret = coll.getItemCount();
			msg.result["collection"]=ret;
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		case 'removeItem':
			msg.cmd="removeItem";
			if ("args" in payload && "itemID" in payload.args)
			{

				var ret = coll.removeItemByID(payload.args.itemID)
				if(ret!=false)
				{
					msg.result["result"]="OK"
					msg.result["itemID"]=ret;
				}
				else{
					msg.result["result"]="NOK"
					msg.result["msg"]="Could not remove item with id="+payload.args.itemID;
				}
			
			}
			else{
				msg.result["result"]="NOK";
				msg.result["msg"]="No item ID provided";			
			}
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		case 'getItem':
			console.log("getting Item");
			if ("args" in payload && "itemID" in payload.args)
			{
				var item = coll.getItem(payload.args.itemID)
				if (item == false)
				{
					msg.result["result"]="NOK";
					msg.result["msg"]="Item with ID ="+payload.args.itemID+"  not available";
 				}			
				else{
					msg.result["result"]="OK";
					msg.result["value"]=item;
				}
			}
			else
			{
				msg.result["result"]="NOK";
				msg.result["msg"]="ItemID not provided";
			}
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		case 'getItems':
			var filter = {};
			var userID = 0; //entire collection
			var limit = -1; //no limite
			var hasFilter =false;
			if ("args" in payload)
			{
				for (fItem in payload.args)
				{
					if (fItem == "userID")
					{
						userID = payload.args.userID;
					}
					else
					{
						hasFilter=true;						
						filter[""+fItem]=payload.args[""+fItem];
					}		
				}
				
				if(hasFilter==false)
				{
					filter=undefined;
				}
			}
			else{filter=undefined;}					
			var res = coll.getItems(userID,limit,filter); //returns array of {itemID:itemID,userID:userId, item=item} tuples
			msg.cmd="getItems";
			msg.result["result"]="OK";
			msg.result["collection"]=res;
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		default:
			msg.result["collection"]="error"
			msg.result["msg"]="could not parse the cmd";
			console.log("Could't parse command - cmd = "+payload.cmd);
			str = JSON.stringify(msg);
			channel.send(msg) 
			break;
		
	}
    }

    /**
     * Test Party Collection
     * 
     **/
    function createParty()
    {
	coll = new PartyCollection("testCollection");
	coll.addItem(users.Victor,item);
	coll.addItem(users.Victor,item);
	coll.addItem(users.Daryll, item);
	coll.addItem(users.Victor,item);
	coll.addItem(users.Daryll, item);
	coll.addItem(users.Arno, item);
	coll.addItem(users.Fabian, item);
	coll.addItem(users.Arno, item);
    }

    function printItems(){
	items = coll.getItems(0);
	console.log(items.length +" items found");
	for (i=0;i<items.length;i++){
		console.log("ID="+items[i].itemID +" , user="+items[i].userID+", item: "+items[i].item.artist +" - "+items[i].item.title);
	}
    }
	

</script>
</head>

<body>
    <h2>webinos PartyPlayer / App2App stub tester</h2>
    <form action="" method="get" accept-charset="utf-8">
	<!--<input type="button" value="CreateParty" onclick="javascript:createParty();">!-->
        <input type="button" value="Init" onclick="javascript:init();">
        <input type="button" value="Search" onclick="javascript:search();">
        <input type="button" value="Create" onclick="javascript:create();">
        <input type="button" value="Send" onclick="javascript:send();">
        <input type="text" id="message" size="60"
            placeholder="Type JSON here..."
            value='{"type":"chat","msg":"vrolijke boel"}'><br>
    </form>

    <h3>Logging</h3>
    <div id=log>
        <div class=logline>Testing one ... two ... in the place to be!</div>
    </div>
</body>
</html>

